---
#
#  Part of https://github.com/jaclu/ish-fstools
#
#  Copyright (c) 2025-2026: Jacob.Lundqvist@gmail.com
#
#  License: MIT
#
#  Prepare env to run playbooks
#   - Install Python on clients if not already available
#   - Parses vars/overrides
#

- name: " pre-task - Ensure Python is installed"
  include_tasks: install_python.yml
  when: not (ift_quick_deploy | default(false))

- name: " pre-task - Gather facts now that Python is available, use cache if present"
  setup:
    gather_subset: all

- name: " pre-task - Handle vars/overrides.yml"
  # Must be first task in order for everything else to use the variable overrides
  import_tasks: process_overrides.yml

- name: " pre-task - Param Checks"
  # Make sure no params are invalid, early on, since each task run on iSH has a
  # high over head 10-20s. So better to abort before waisting time
  include_tasks: param_checks.yml
  when: not (ift_quick_deploy | default(false)) # should have triggered on initial deploy

- name: " pre-task - Check if this is iSH"
  # Might depend on some overrides, so run after process_overrides
  import_tasks: is_ish.yml

- name: " pre-task - Set old_ansible if this is ansible < 2.8"
  set_fact:
    old_ansible: >-
      {{ ansible_version.major < 2
        or (ansible_version.major == 2
            and ansible_version.minor < 8) }}
  delegate_to: localhost
  run_once: true

- name: " pre-task - Check if this is old ansible < 2.8"
  debug:
    msg: "         old_ansible: {{ old_ansible }}"
  changed_when: ift_show_extra_status | default(false)
  when: old_ansible or (ift_show_extra_status | default(false))
  delegate_to: localhost
  run_once: true

- name: " pre-task - Clone this on remote end"
  # Must be first task in order for everything else to use the variable overrides
  include_tasks: remote_repo.yml
  when: not (skip_cloning | default(false))
