---

#
#  Part of https://github.com/jaclu/ish-fstools
#
#  Copyright (c) 2025: Jacob.Lundqvist@gmail.com
#
#  License: MIT
#
#  Install selected Alpine apps
#

# - name: Display all packages being installed
#   ansible.builtin.debug:
#     msg: |
#       Alpine packets to be installed:
#       {% for pkg in ift_alpine_packages %}
#         {{ pkg }}
#       {% endfor %}

- name: Install selected packages
  ansible.builtin.include_tasks: tasks/install_apk.yml
  vars:
    apk_packages: "{{ ift_alpine_packages }}"
  when: ift_alpine_packages is defined and ift_alpine_packages | length > 0

- name: Ensure /usr/bin/uptime is symlink to /bin/busybox
  ansible.builtin.shell: |
    ex_code=0
    if [ ! -L /usr/bin/uptime ] || \
       [ "$(readlink -f /usr/bin/uptime)" != "/bin/busybox" ]; then
        if [ -e /usr/bin/uptime ]; then
            rm -f /usr/bin/uptime.ORG # only remove .ORG if it will be replaced
            mv -f /usr/bin/uptime /usr/bin/uptime.ORG || exit 1
        fi
        ln -sf /bin/busybox /usr/bin/uptime || exit 2
        ex_code=43
    fi
    exit "$ex_code"
  args:
    executable: /bin/sh
  register: alpine_rename_uptime
  changed_when: alpine_rename_uptime.rc == 43
  failed_when: alpine_rename_uptime.rc not in [0, 43]

- name: Install extras to /usr/local/bin
  # become: true
  ansible.builtin.copy:
    mode: preserve
    remote_src: true
    src: "{{ alpine_d_repo }}/files/usr_local_bin/"
    dest: /usr/local/bin/

- name: Install extras to /usr/local/sbin
  # become: true
  ansible.builtin.copy:
    mode: preserve
    remote_src: true
    src: "{{ alpine_d_repo }}/files/usr_local_sbin/"
    dest: /usr/local/sbin/
