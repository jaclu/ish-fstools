---

#
#  Part of https://github.com/jaclu/ish-fstools
#
#  Copyright (c) 2025: Jacob.Lundqvist@gmail.com
#
#  License: MIT
#
#  Installs apps common for all Distros
#

- name: Common apps - Install extras to /usr/local/lib
  # become: true
  ansible.builtin.copy:
    remote_src: true
    mode: preserve
    src: "{{ d_repo_all_distros_role }}/files/usr_local_lib/"
    dest: /usr/local/lib/

- name: Deploy /usr/local/lib/ift-utils.sh with correct d_repo path
  ansible.builtin.template:
    remote_src: true
    src: ift-utils.sh.js2
    dest: /usr/local/lib/ift-utils.sh
    mode: '0755'

- name: Common apps - Install extras to  /usr/local/bin
  # become: true
  ansible.builtin.copy:
    remote_src: true
    mode: preserve
    src: "{{ d_repo_all_distros_role }}/files/usr_local_bin/"
    dest: /usr/local/bin/

- name: Common apps - Install extras to  /usr/local/sbin
  # become: true
  ansible.builtin.copy:
    remote_src: true
    mode: preserve
    src: "{{ d_repo_all_distros_role }}/files/usr_local_sbin/"
    dest: /usr/local/sbin/


- name: "Common apps - Rename Alpine bins -> name.ORG if found, and softlink ours"
  #
  #  Minimizes risk of orig bin being run
  #
  ansible.builtin.shell: |
    set -o pipefail
    ex_code=0
    hide_bins=(
        /bin/hostname
        /sbin/halt
        /sbin/shutdown
        /usr/bin/logger
        # /usr/bin/uptime - needed for replacement uptime!
    )
    for hide_bin in "${hide_bins[@]}"; do
        [[ -L "$hide_bin" ]] && [[ $(realpath "$hide_bin") != /bin/busybox  ]] && {
          continue # already linked to ours
        }
        if [[ -f "$hide_bin" ]]; then
            mv "$hide_bin" "${hide_bin}.ORG" || exit 1
            d_location="$(dirname "$hide_bin")"
            b_name="$(basename "$hide_bin")"
            case "$d_location" in
                /bin | /usr/bin) d_our_location=/usr/local/bin ;;
                /sbin | /usr/sbin) d_our_location=/usr/local/sbin ;;
                *)
                    echo "Unknown path: $d_location"
                    exit 1
                    ;;
            esac
            f_our_bin="$d_our_location/$b_name"
            if [[ -f "$f_our_bin" ]]; then
                ln -sf "$f_our_bin" "$hide_bin" || exit 2
            else
                echo "Unknown alt bin: $f_our_bin"
                exit 1
            fi
            ex_code=43
        fi
    done
    exit "$ex_code"
  args:
    executable: /bin/bash
  register: all_distros_bin_replacement
  changed_when: all_distros_bin_replacement.rc == 43
  failed_when:
    - all_distros_bin_replacement.rc not in [0, 43]
  when: ansible_os_family == 'Alpine'
