---
#
#  Part of https://github.com/jaclu/ish-fstools
#
#  Copyright (c) 2025: Jacob.Lundqvist@gmail.com
#
#  License: MIT
#
#  All distros task
#

- name: Run verify_shell_exists.yml
  ansible.builtin.import_tasks: verify_shell_exists.yml
  when: ift_shell is defined and ift_shell

- name: Common apps
  ansible.builtin.import_tasks: common_apps.yml

- name: Configs for /etc
  ansible.builtin.import_tasks: etc_configs.yml

- name: Run timezone.yml
  ansible.builtin.import_tasks: timezone.yml
  when: ift_timezone is defined and ift_timezone

- name: Run services.yml
  ansible.builtin.import_tasks: services.yml

- name: Run user_account.yml
  ansible.builtin.import_tasks: user_account.yml
  when:
    - ift_user_name is defined
    - ift_user_name | length > 0

- name: Run root_shell.yml
  ansible.builtin.import_tasks: root_shell.yml
  when: ift_shell is defined and ift_shell

- name: Copy /etc/skel files to root home (without overwrite)
  ansible.builtin.command: cp -ru /etc/skel/. /root/
  args:
    creates: /root/.profile # or any file you expect from skel
  # become: true

- name: Check if this is iSH
  ansible.builtin.include_tasks: tasks/is_ish.yml
  when: vars['is_ish'] is not defined

- name: "Enable launcher on iSH: {{ f_app_ift_launcher }}"
  ansible.builtin.shell: |
    set -o pipefail
    ex_code=0
    tmp_file=$(mktemp)
    config-ift -l > "$tmp_file" | exit 1
    if grep -qv "{{ f_app_ift_launcher }}" "$tmp_file"; then
        {{ f_app_ift_config }} -l ift | exit 2
        ex_code=43
    fi
    rm -f "$tmp_file"
    exit "$ex_code"
  args:
    executable: /bin/bash
  register: all_distros_launcher
  changed_when: all_distros_launcher.rc == 43
  failed_when: all_distros_launcher.rc not in [0, 43]
  when: is_ish | default(false)

- name: "Set chroot default command: {{ f_app_ift_launcher }}"
  ansible.builtin.copy:
    dest: /.chroot_default_cmd
    content: "{{ f_app_ift_launcher }}\n"
    owner: root
    group: root
    mode: "0644"
  when: not is_ish | default(false)
