---

#
#  Copyright (c) 2025: Jacob.Lundqvist@gmail.com
#
#  License: MIT
#
#  Installs basic sshd service
#

- name: Service sshd - create symbolic link
  ansible.builtin.file:
    src: "{{ d_init_ift }}/sshd"
    dest: "{{ f_srvc_sshd }}"
    state: link

- name: "Service sshd - Check if it is in runlevel: {{ ift_runlevel_sshd }}"
  ansible.builtin.shell: |
    set -o pipefail
    rc-status "{{ ift_runlevel_sshd }}" | grep -q '^ sshd'
  register: all_distros_sshd_check
  changed_when: false
  failed_when: false

- name: Service sshd - Add to runlevel if needed
  ansible.builtin.command: rc-update add sshd "{{ ift_runlevel_sshd }}"
  when: all_distros_sshd_check.rc != 0
  changed_when: true

- name: "Service sshd - set Port to: {{ ift_port_sshd | default(2022) }}"
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^\#Port '
    line: 'Port {{ ift_port_sshd | default(2022) }}  # Defined by ish-fstools'
  when: ift_port_sshd is defined and ift_port_sshd != ""
