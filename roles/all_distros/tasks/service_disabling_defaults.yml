---
#
#  Part of https://github.com/jaclu/ish-fstools
#
#  Copyright (c) 2025-2026: Jacob.Lundqvist@gmail.com
#
#  License: MIT
#
# Disable all default services, then soft-link all servicess found in
# {{ d_init_ift }} to /etc/init.d
#
#  for f in /etc/init.d/*; do

# - name: "Default services - Ensure folder exists {{ d_init_not }}"
#   file:
#     path: "{{ d_init_not }}"
#     state: directory
#     mode: "0755"

- name: "Default services - Move Ansible services to {{ d_init_not }}"
  shell:
    cmd: |
      ex_code=0
      for f in "{{ d_init_d }}"/*; do
        [ -f "$f" ] && [ ! -L "$f" ] && {
          mv "$f" "{{ d_init_not }}"/ || exit 30
          ex_code=43 # indicate that at least one service was moved
        }
      done
      exit "$ex_code"
  args:
    executable: /bin/sh
  register: all_distros_services_moved
  changed_when: all_distros_services_moved.rc == 43
  failed_when: all_distros_services_moved.rc not in [0, 43]

# - name: "Default services - Ensure folder exists {{ d_init_ift }}"
#   file:
#     path: "{{ d_init_ift }}"
#     state: directory
#     mode: "0755"

- name: "Default services - Sync ish-fstools links into {{ d_init_d }}"
  shell:
    cmd: |
      changed=0
      # Ensure all valid targets are linked
      for src in /etc/init.d/ish-fstools/*; do
        [ -f "$src" ] || continue
        dest="{{ d_init_d }}/$(basename "$src")"
        if [ ! -e "$dest" ]; then
          ln -s "$src" "$dest" || exit 30
          echo "LINKED $dest"
          changed=43
        fi
      done

      # Remove broken links pointing into ish-fstools
      for link in "{{ d_init_d }}"/*; do
        [ -L "$link" ] || continue
        target=$(readlink "$link")
        case "$target" in
          "{{ d_init_ift }}"/*)
            [ -e "$target" ] && continue
            rm -f "$link"
            echo "REMOVED $link"
            changed=43
            ;;
        esac
      done

      exit $changed
  args:
    executable: /bin/sh
  register: all_distros_ish_link_output
  changed_when: all_distros_ish_link_output.rc == 43
  failed_when: all_distros_ish_link_output.rc not in [0, 43]
