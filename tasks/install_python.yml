---
#
#  Part of https://github.com/jaclu/ish-fstools
#
#  Copyright (c) 2025: Jacob.Lundqvist@gmail.com
#
#  License: MIT
#
#  Installs Python3 if missing
#

- name: Install Python via raw shell if missing
  ansible.builtin.raw: |
    if ! command -v python3 >/dev/null 2>&1; then
        if command -v yum >/dev/null 2>&1; then
            # RHEL, CentOS, Rocky, Alma, Amazon Linux
            yum install -y python3 && exit 43
            exit 1
        elif command -v dnf >/dev/null 2>&1; then
            # Fedora, newer RHEL/CentOS
            dnf install -y python3 && exit 43
            exit 1
        elif command -v apt-get >/dev/null 2>&1; then
            # Debian / Ubuntu
            apt-get update && apt-get install -y python3 && exit 43
            exit 1
        elif command -v zypper >/dev/null 2>&1; then
            # SUSE / OpenSUSE
            zypper --non-interactive install python3 && exit 43
            exit 1
        elif command -v apk >/dev/null 2>&1; then
            # Alpine
            apk add --no-cache python3 && exit 43
            exit 1
        else
            echo "Unsupported system, cannot install Python3" >&2
            exit 1
        fi
    fi
    exit 0
  register: python_installed
  changed_when: python_installed.rc == 43
  failed_when: python_installed.rc not in [0, 43]

- name: Gather facts now that Python is available, use cache if present
  ansible.builtin.setup:
    gather_subset: all
